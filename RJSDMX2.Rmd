---
title: "Accessing RSDMX-data from R"
author: "Albrecht Gradmann"
date: "March 10th, 2015"
output: rmarkdown::tufte_handout
---
```{r globals, echo=FALSE}
library("knitr")
opts_chunk$set(message='FALSE',results='hide')
```




# Introduction
Reproducibility 
[^sdmxorg]
[^rjsdmx_pres]

We want to reproduce a figure about the 'Stucture of utilised agricultural area, 2007(% of UAA)
\begin{figure}
\includegraphics{resources/Capture.PNG}
\caption{An equation}
\end{figure}






This example shows how to use this technology to programmatically download data from Eurostat, re-format and subset the retrieved data and create a figure using the ggplot2[^ggplot2] package. To have a 

[^sdmxorg]:Homepage of the Statistical Data and Metadata eXchange (SDMX)  http://sdmx.org/
[^rjsdmx_pres]: Mattiocco, A. (2013): Using SDMX data in statistical packages and tools (EXCEL, R, Matlab, SAS). Presentation. http://tinyurl.com/RJSDMX-pres
[^ggplot2]: Homepage of Hadley Wickhams ggplot2.http://ggplot2.org/

# Setting the scene
You can recreate the results presented here by running the source-code snippets in a R-session. If you want to avoid copy-pasting the snippets from the pdf into a R session, you can also run the example from the source-code of this document which I can provide you upon request.

Before going through the individual steps presented below, you need to load the following libraries:

```{r libraries,results='hide',message=FALSE}
library(ggplot2)  # Hadley Wickhams plotting package
library(RJSDMX)   # Needed to query Eurostat REST-interface
library(dplyr)    # Library for manipulating data
library(scales)   # Needed for percentage scales

```
```{r layout_libs,echo=FALSE}
library(xtable)
```
If you receive error messages at this stage, you probably have not yet installed these packages on your system.  Package installation in R is a simple and standard task and it can be done in several ways. For more information, you can either type  `help("install.packages")` in the R Console or look for one of the numerous tutorials on the internet[^howto_install]. 

Although I tried to design this as a self-contained example it might not work as expected on your system. In that case, please do not hesitate to get in touch directly.


[^howto_install]: How to install packages in R http://tinyurl.com/nh7whtp

[^fss-slov]: Statistics in Focus 87/2007: Farm Structure in Slovenia 2007 http://tinyurl.com/fss-slov
 


# Steps
The following sections  

## Define the REST-Call

```{r getFlows,cache=TRUE,message=TRUE,results='markup'}
getFlows(provider = "EUROSTAT",pattern = "ef_ov_lusum")
```


```{r getDimensions,message=TRUE, results='markup'}
names(getDimensions(provider = "EUROSTAT",dataflow = "ef_ov_lusum"))
```

```{r getCodesFREQ,results='markup'}
FREQ_Codes <- getCodes(provider = "EUROSTAT",
           flow = "ef_ov_lusum",
           dimension = "FREQ")

data.frame(unlist(FREQ_Codes))

```
```{r getCodesVARIABLE}
VARIABLE_Codes <- getCodes(provider = "EUROSTAT",
           flow = "ef_ov_lusum",
           dimension = "VARIABLE")

VARIABLE_Codes <- data.frame(VARIABLE=names(VARIABLE_Codes),
                             labels=unlist(VARIABLE_Codes),
                             row.names=NULL)
```

[^fss-slov]
[^fss-slov]: Statistics in Focus 87/2007: Farm Structure in Slovenia 2007 http://tinyurl.com/fss-slov

A.TOTAL.TOTAREA+D18+G+D+F.HA.TOTAL.*
```{r getData,cache=TRUE}
listSdmx <- getSDMX(provider = "EUROSTAT",
                    id = "ef_ov_lusum.A.TOTAL.D+E+F+G+H.HA.TOTAL.*",
                    start = "2007",
                    end="2007")

dfSdmx <- sdmxdf(listSdmx,meta = T)
```

```{r dplyr}
dfSdmx <- 
  dfSdmx %>%
  inner_join(VARIABLE_Codes)%>%
  select(GEO, VARIABLE,labels, OBS) %>%
  arrange(GEO) %>%
  filter(!GEO %in% c("CH","FX")) %>%
  group_by(GEO) %>%
  mutate(PC=OBS/sum(OBS))

# Re-order levels
dfSdmx$GEO <-  factor(dfSdmx$GEO, levels = rev(levels(dfSdmx$GEO)))
# Re-name some levels for smaller legend
levels(dfSdmx$labels)[24] <- "Permanent grassland\nand meadows"
levels(dfSdmx$labels)[16] <- "Other"

```

```{r firstplot,fig.cap="Hallo",fig.width=6,fig.height=6}
gg <- ggplot(data=dfSdmx, aes(x=GEO,y=PC,fill=labels)  )
gg <- gg + geom_bar(stat="identity",) 
gg <- gg + coord_flip() 
gg <- gg + scale_y_continuous(labels = percent)
gg <- gg + scale_fill_brewer(type = "qual")
gg 
```



```{r windowdressing,fig.width=6,fig.height=6}
theme_qual <- function(base_size=11, base_family="") {
  require(grid)
  theme_bw(base_size=base_size, base_family=base_family) %+replace%
    theme(
      axis.title=element_blank(),
      legend.position = "bottom",
      legend.title=element_blank()
    )
}

gg <- gg+ theme_qual()
gg
```

```{r betterplot,fig.width=6,fig.height=6}


dfSdmx$GEO <-  factor(dfSdmx$GEO, levels = rev(levels(dfSdmx$GEO)))

gg <- gg %+% dfSdmx
gg <- gg + coord_cartesian()+facet_wrap(facets = "labels",ncol = 1,)
gg <- gg + scale_fill_brewer(type = "qual",guide=FALSE)
gg
```













