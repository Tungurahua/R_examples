---
title: "Accessing RSDMX-data from R"
author: "Albrecht Gradmann"
date: "March 10th, 2015"
output: rmarkdown::tufte_handout
---

# Introduction
Reproducibility 
[^sdmxorg]
[^rjsdmx_pres]

We want to reproduce a figure about the 'Stucture of utilised agricultural area, 2007(% of UAA)
\begin{figure}
\includegraphics{resources/fig25_eurostat.PNG}
\caption{An equation}
\end{figure}






This example shows how to use this technology to programmatically download data from Eurostat, re-format and subset the retrieved data and create a figure using the ggplot2[^ggplot2] package. To have a 

[^sdmxorg]:Homepage of the Statistical Data and Metadata eXchange (SDMX)  http://sdmx.org/
[^rjsdmx_pres]: Mattiocco, A. (2013): Using SDMX data in statistical packages and tools (EXCEL, R, Matlab, SAS). Presentation. http://tinyurl.com/RJSDMX-pres
[^ggplot2]: Homepage of Hadley Wickhams ggplot2.http://ggplot2.org/

# Setting the scene
You can recreate the results presented here by running the source-code snippets in a R-session. If you want to avoid copy-pasting the snippets from the pdf into a R session, you can also run the example from the source-code of this document which I can provide you upon request.

Before going through the individual steps presented below, you need to load the following libraries:

```{r libraries,results='hide',tidy=FALSE,message=FALSE}
library(ggplot2)  # Hadley Wickhams plotting package
library(RJSDMX)   # Query Eurostat REST-interface
```
```{r layout_libs,echo=FALSE,message=FALSE}
library(xtable)
```
If you receive error messages at this stage, you probably have not yet installed these packages on your system.  Package installation in R is a simple and standard task and it can be done in several ways. For more information, you can either type  `help("install.packages")` in the R Console or look for one of the numerous tutorials on the internet[^howto_install]. 

Although I tried to design this as a self-contained example it might not work as expected on your system. In that case, please do not hesitate to get in touch directly.


[^howto_install]: How to install packages in R http://tinyurl.com/nh7whtp


 


# Steps
The following sections  

## Define the REST-Call

```{r getFlows}
getFlows(provider = "EUROSTAT",pattern = "ef_ov_lusum")
```


```{r getDimensions}
names(getDimensions(provider = "EUROSTAT",dataflow = "ef_ov_lusum"))
```

```{r getCodesFREQ}
FREQ_Codes <- getCodes(provider = "EUROSTAT",
           flow = "ef_ov_lusum",
           dimension = "FREQ")

data.frame(unlist(FREQ_Codes))

```

```{r getCodesTERRTYPO}
TERRTYPO_Codes <- getCodes(provider = "EUROSTAT",
           flow = "ef_ov_lusum",
           dimension = "TERRTYPO")

data.frame(unlist(TERRTYPO_Codes))
```

```{r getCodesVARIABLE}
VARIABLE_Codes <- getCodes(provider = "EUROSTAT",
           flow = "ef_ov_lusum",
           dimension = "VARIABLE")

View(data.frame(unlist(VARIABLE_Codes)))
```

```{r getCodesUNIT}
UNIT_Codes <- getCodes(provider = "EUROSTAT",
           flow = "ef_ov_lusum",
           dimension = "UNIT")

data.frame(unlist(UNIT_Codes))
```

```{r getCodesAGRAREA}
AGRAREA_Codes <- getCodes(provider = "EUROSTAT",
           flow = "ef_ov_lusum",
           dimension = "AGRAREA")

data.frame(unlist(AGRAREA_Codes))
```

A.TOTAL.TOTAREA+D18+G+D+F.HA.TOTAL.*
```{r}
listSdmx <- getSDMX(provider = "EUROSTAT",id = "ef_ov_lusum.A.TOTAL.TOTAREA+D18+G+D+F.HA.TOTAL.*",start = "2007",end="2007")
```

```{r}
dfSdmx <- sdmxdf(listSdmx,meta = T)
str(dfSdmx2)
dfSdmx <- dfSdmx[,c("GEO","VARIABLE","OBS")]
dfSdmx2$OBSpc

library(plyr)

avg <- function(x){x/sum(x)}

head(ddply(dfSdmx,c("GEO","Vari"),D=avg(OBS)))

```

```{r}

gg <- ggplot(data=dfSdmx, aes(x=GEO,y=OBS,fill=VARIABLE)  )
gg <- gg + geom_bar(stat="identity",) 
gg
```




The programmatic approach to downloading data from Eurostat requires the definition of an \emph{identifier} to specify  

## Get the data

Images and graphics play an integral role in Tufte's work. To place figures or tables in the margin you can use the `fig.margin` knitr chunk option. For example:

```{r, fig.margin = TRUE, fig.cap = "Sepal length vs. petal length, colored by species"}
library(ggplot2)
qplot(Sepal.Length, Petal.Length, data = iris, color = Species)
```

Note the use of the `fig.cap` chunk option to provide a figure caption. You can adjust the proportions of figures using the `fig.width` and `fig.height` chunk options. These are specified in inches, and will be automatically scaled down to fit within the handout margin.

## Equations

You can also include \LaTeX\ equations in the margin by explicitly invoking the `marginfigure` environment.

\begin{marginfigure}
$$\frac{d}{dx}\left( \int_{0}^{x} f(u)\,du\right)=f(x).$$
\caption{An equation}
\end{marginfigure}

Note the use of the `\caption` command to add additional text below the equation.

## Full Width Figures

You can arrange for figures to span across the entire page by using the `fig.fullwidth` chunk option. 

```{r, fig.width = 10, fig.height = 2, fig.fullwidth = TRUE, fig.cap = "Full width figure"}
qplot(wt, mpg, data=mtcars, colour=factor(cyl))
```

Note the use of the `fig.width` and `fig.height` chunk options to establish the proportions of the figure. Full width figures look much better if their height is minimized.

## Main Column Figures

Besides margin and full width figures, you can of course also include figures constrained to the main column.

```{r, fig.cap = "Another figure"}
qplot(factor(cyl), mpg, data = mtcars, geom = "boxplot")
```

# Sidenotes

One of the most prominent and distinctive features of this style is the extensive use of sidenotes. There is a wide margin to provide ample room for sidenotes and small figures. Any use of a footnote will automatically be converted to a sidenote. ^[This is a sidenote that was entered using a footnote.] 

If you'd like to place ancillary information in the margin without the sidenote mark (the superscript number), you can use the `\marginnote` command. \marginnote{This is a margin note.  Notice that there isn't a number preceding the note.}

Note also that the two footnote references (`tufte_latex` and `books_be`, both defined below) were also included in the margin on the first page of this document.

# Tables

You can use the **xtable** package to format \LaTeX\ tables that integrate well with the rest of the Tufte handout style. Note that it's important to set the `xtable.comment` and `xtable.booktabs` options as shown below to ensure the table is formatted correctly for inclusion in the document.

```{r, results='asis'}
library(xtable)
options(xtable.comment = FALSE)
options(xtable.booktabs = TRUE)
xtable(head(mtcars[,1:6]), caption = "First rows of mtcars")
```


[^tufte_latex]: https://code.google.com/p/tufte-latex/
[^books_be]: http://www.edwardtufte.com/tufte/books_be










