---
title: "Accessing RSDMX-data from R"
author: "Albrecht Gradmann"
date: "March 10th, 2015"
output: rmarkdown::tufte_handout
---
```{r globals, echo=FALSE}
library("knitr")
opts_chunk$set(message='FALSE',results='hide')

```




# Introduction
R is a programming language specifically designed for statistical computing and graphics. To carry out calculations, analyse data and to produce graphics the user has to write and execute commands. Working with R is much less intuitive than working with spreadsheet software like MS-Excel or OO-Calc where the user is aided by an elaborate graphical user interface. As a result R has a steep learning curve and it takes some effort to get used to it. If the task at hand is the generation of 'simple' bar-charts, line graphs or similar displays, the use of R may therefore seem excessive. However, the programmatic approach followed by R has several advantages:
\begin{itemize}
  \item Writing a program  instead of carrying out a series mouse clicks ensures that the work is reproducible. This provides great opportunities for quality control and peer review. 
  \item Computer code created to generate specific figures can often be adapted to address new questions with rather low effort.
  \item Nowadays many data providers offer programmatic interfaces to their databases. This allows to carry out analysis 'from cradle to grave' with a single tool.
\end{itemize}

In 2001 SDMX[^sdmxorg], an initative to foster standards for the exchange of statistical information has been started. Within this initiative a standard protocol for the exchange of statistical data and metadata has been adopted. 
progra  Reproducibility 

[^rjsdmx_pres]


We want to reproduce a figure about the 'Stucture of utilised agricultural area, 2007(% of UAA) [^statcc]
\begin{figure}
\label{fig:25_eurostat}
\includegraphics{resources/fig25_eurostat.PNG}
\caption{An equation }
\end{figure}






This example shows how to use this technology to programmatically download data from Eurostat, re-format and subset the retrieved data and create a figure using the ggplot2[^ggplot2] package. To have a 

[^sdmxorg]:Homepage of the Statistical Data and Metadata eXchange (SDMX)  http://sdmx.org/
[^rjsdmx_pres]: Mattiocco, A. (2013): Using SDMX data in statistical packages and tools (EXCEL, R, Matlab, SAS). Presentation. http://tinyurl.com/RJSDMX-pres
[^ggplot2]: Homepage of Hadley Wickhams ggplot2.http://ggplot2.org/
[^statcc]: EUROSTAT 2010: Using official statistics to calculate greenhouse gas emissions - A statistical guide. http://tinyurl.com/stat-guide-cc



# Setting the scene
You can recreate the results presented here by running the source-code snippets in a R-session. If you want to avoid copy-pasting the snippets from the pdf into a R session, you can also run the example from the source-code of this document which is available as part of I can provide you upon request.

Before going through the individual steps presented below, you need to load the following libraries:

```{r libraries,results='hide',message=FALSE}
library(ggplot2)  # Hadley Wickhams plotting package
library(RJSDMX)   # Needed to query Eurostat REST-interface
library(dplyr)    # Library for manipulating data
library(scales)   # Needed for percentage scales

```
```{r layout_libs,echo=FALSE}
library(xtable)
```
If you receive error messages at this stage, you probably have not yet installed these packages on your system.  Package installation in R is a simple and standard task and it can be done in several ways. For more information, you can either type  `help("install.packages")` in the R Console or look for one of the numerous tutorials on the internet[^howto_install]. 

Although I tried to design this as a self-contained example it might not work as expected on your system. In that case, please do not hesitate to get in touch directly.


[^howto_install]: How to install packages in R http://tinyurl.com/nh7whtp

[^fss-slov]: Statistics in Focus 87/2007: Farm Structure in Slovenia 2007 http://tinyurl.com/fss-slov
 


# Steps
The following sections  

## Define the REST-Call

```{r getFlows,message=TRUE,results='hide',tidy=FALSE,echo=1}
getFlows(provider = "EUROSTAT",pattern = "ef_ov_lusum")
message("$ef_ov_lusum")
message('[1] "ESTAT,ef_ov_lusum,1.0 ; Land use: number of')
message('farms and areas by size of farm (UAA) and LFA status"')
```

```{r getDimensions,cache=TRUE,message=TRUE, results='markup',tidy=FALSE}
names(getDimensions(provider = "EUROSTAT",
                    dataflow = "ef_ov_lusum"))
```

```{r getCodes,message=TRUE,cache=TRUE, results='markup',tidy=FALSE}
FREQ_Codes <- getCodes(provider = "EUROSTAT",  
                       flow = "ef_ov_lusum",
                       dimension = "FREQ")

data.frame(codes=names(FREQ_Codes),
                             labels = unlist(FREQ_Codes),
                             row.names = NULL)
```

\begin{figure}
\includegraphics{resources/Eurostat_REST.PNG}
\caption{The Eurostat Data Explorer is organized around the concepts of 'dataflow', 'Dimensions' and 'Codes'. Unfortunately it is not possible to extract the REST-id string from this application.}
\end{figure}


[^restbuild]

The developer of `RSDMX` is currently working on a java tool[^javatool] which will provide a gui for the creation of REST-ids. 

For the time being, you can resort to 



```{r getCodesVARIABLE,cache=TRUE}
VARIABLE_Codes <- getCodes(provider = "EUROSTAT",
           flow = "ef_ov_lusum",
           dimension = "VARIABLE")

VARIABLE_Codes <- data.frame(VARIABLE=names(VARIABLE_Codes),
                             labels=unlist(VARIABLE_Codes),
row.names=NULL)
```

[^fss-slov]

\begin{figure}
\centering
\includegraphics[width=8cm]{resources/Land_use_by_size_of_the_farms,_Slovenia,_2007.PNG}
\caption{Hierarchical structure of the Size-of-farms statistics at Eurostat. The structure of the dataset does not match the with the one shown in figure \ref{fig:25_eurostat}. }
\end{figure}
```{r idString}
idString = "ef_ov_lusum.A.TOTAL.D+E+F+G+H.HA.TOTAL.*"
```




```{r getData,cache=TRUE,tidy=FALSE}
listSdmx <- getSDMX(provider = "EUROSTAT",
                    id = idString,
                    start = "2007",
                    end="2007")

dfSdmx <- sdmxdf(listSdmx, meta = T)
```

[^javatool]:  https://github.com/amattioc/SDMX/issues/41
[^restbuild]: Query Builder at Eurostat. Only available for limited numberof datasets. http://ec.europa.eu/eurostat/web/sdmx-web-services/query-builder
[^fss-slov]: Statistics in Focus 87/2007: Farm Structure in Slovenia 2007 http://tinyurl.com/fss-slov

# Re-organizing the dataset

```{r dplyr, warning=FALSE,message=FALSE}
dfSdmx <- 
  dfSdmx %>%
  inner_join(VARIABLE_Codes)%>%
  select(GEO, VARIABLE,labels, OBS) %>%
  arrange(GEO) %>%
  filter(!GEO %in% c("CH","FX")) %>%
  group_by(GEO) %>%
  mutate(PC=OBS/sum(OBS))

# Re-order levels
dfSdmx$GEO <-  factor(dfSdmx$GEO, levels = rev(levels(dfSdmx$GEO)))

# Re-name some levels for smaller legend
levels(dfSdmx$labels)[24] <- "Permanent grassland and meadows"
levels(dfSdmx$labels)[16] <- "Other"
dfSdmx$labels
```

```{r firstplot,fig.cap="Hallo",fig.width=6,fig.height=6}
gg <- ggplot(data=dfSdmx, aes(x=GEO,y=PC,fill=labels,order=labels)  )
gg <- gg + geom_bar(stat="identity",width=0.5) 
gg <- gg + coord_flip() 
gg <- gg + scale_y_continuous(labels = percent)
gg <- gg + scale_fill_brewer(type = "qual")
gg
```



```{r windowdressing,fig.width=6,fig.height=6,message=FALSE,warning=FALSE,tidy=FALSE}
theme_qual <- function(base_size=11, base_family="") {
  require(grid)
  theme_bw(base_size=base_size, 
           base_family=base_family) %+replace%
    theme(axis.title=element_blank(),
      legend.position = "bottom",
      legend.title=element_blank())
}

gg <- gg +  theme_qual()
gg <- gg + guides(fill = guide_legend(keywidth = 0.8, keyheight = 0.8,nrow = 2,byrow = TRUE))  
gg
```

```{r betterplot,fig.width=6,fig.height=6,warning=FALSE,message=FALSE}


dfSdmx$GEO <-  factor(dfSdmx$GEO, levels = rev(levels(dfSdmx$GEO)))

gg <- gg %+% dfSdmx
gg <- gg + coord_cartesian()+facet_wrap(facets = "labels",nrow = 5)
gg <- gg + scale_fill_brewer(type = "qual",guide=FALSE)
gg
```













