---
title: "Accessing RSDMX-data from R"
author: "Albrecht Gradmann"
date: "March 10th, 2015"
output: rmarkdown::tufte_handout
---
```{r globals, include=FALSE}
library("knitr")
opts_chunk$set(message='FALSE',results='hide')

```




# Introduction
R is a programming language specifically designed for statistical computing and graphics. To carry out calculations, analyse data and to produce graphics the user has to write and execute commands. Working with R is much less intuitive than working with spreadsheet software like MS-Excel or OO-Calc where the user is aided by an elaborate graphical user interface. As a result R has a steep learning curve and it takes some effort to get used to it. If the task at hand is the generation of 'simple' bar-charts, line graphs or similar displays, the use of R may therefore seem excessive. However, the programmatic approach followed by R has several advantages:

\begin{itemize}
  \item Writing a program  instead of carrying out a series mouse clicks ensures that the work is reproducible. This provides great opportunities for quality control and peer review. 
  \item Computer code created to generate specific figures can often be adapted to address new questions with rather low effort.
  \item Many data providers offer programmatic interfaces to their databases. This allows to carry out analysis 'from cradle to grave' with a single tool.
\end{itemize}

In 2001 SDMX[^sdmxorg], an initative to foster standards for the exchange of statistical information has been started. Within this initiative a standard protocol for the exchange of statistical data and metadata has been adopted. This standard has been adapted by major institutions such as Eurostat, OECD, Worldbank, IMF and others to provide a common interface for data access and retrieval.

In the present example data in SDMX format will be retrieved from Eurostat to produce a figure. Eurostats databse will be accessed through RJSDMX[^rjsdmx_pres] which is a relatively new R-library that provides a convenient interface to Eurostats REST-interface. The data will then undergo some re-formatting and subsetting which is necessary to display the data  using the ggplot2[^ggplot2] package. ggplot2 is a popular plotting library base on Leland Wilkinsons Grammar of Graphics [^Wilkinson]

In the example we want to reproduce figure \ref{fig:25_eurostat} about the 'Stucture of utilised agricultural area, 2007(\% of UAA) which has been published by Eurostat in 2010.[^statcc]  The figure shows the share of different farming practices in EU countries. The amount of $CO_2$ emitted from farming is, to some degree, related to the type of farming practices; extensively farmed land tends to accumulate carbon, while intensively farmed areas (cropland) tend to lose carbon. 

\begin{figure}
\label{fig:25_eurostat}
\includegraphics{resources/fig25_eurostat.PNG}
\caption{Structure of utilised agricultural area, 2007 (\% of UAA).}
\end{figure}

The present text does not aim to discuss the strengths and weaknesses of the chosen figure to make the intended point, and there has not been any specific rationale in the choice of the specific figure. Instead the text will focus on the technicalities of the integrated workflow from the download of the data to plot creation.


<!-- References -->
[^sdmxorg]:Homepage of the Statistical Data and Metadata eXchange (SDMX)  http://sdmx.org/
[^rjsdmx_pres]: Mattiocco, A. (2013): Using SDMX data in statistical packages and tools (EXCEL, R, Matlab, SAS). Presentation. http://tinyurl.com/RJSDMX-pres
[^ggplot2]: Homepage of Hadley Wickhams ggplot2.http://ggplot2.org/
[^statcc]: See p. 41 in EUROSTAT 2010: Using official statistics to calculate greenhouse gas emissions - A statistical guide. http://tinyurl.com/stat-guide-cc
[^Wilkinson]: Wilkinson: The Grammar of Graphics. 


# Setting the scene
In R work is done by issueing a series of commands to a 'command-line'. You will find all the commands necessary to reproduce the final and intermediate results below. You can recreate the results presented here by running these source-code snippets in a R-session. 

If you want to avoid copy-pasting the snippets from the pdf into a R session, you can also run the example from the source-code of this document which is available at Git-Hub.[^github-sources]  you upon request.

Before going through the individual steps presented below, you need to load the following libraries:
\newpage

```{r libraries,results='hide',message=FALSE}
library(ggplot2)  # Hadley Wickhams plotting package
library(RJSDMX)   # Provides Access to Eurostats REST-interface
library(dplyr)    # Aids manipulation of data
library(scales)   # Needed to display percentage scales

```
```{r layout_libs,echo=FALSE}
library(xtable)
```
If you receive error messages at this stage, you probably have not yet installed these packages on your system.  Package installation in R is a simple and standard task and it can be done in several ways. For more information, you can either type  `help("install.packages")` in the R Console or look for one of the numerous tutorials on the internet[^howto_install]. 

Although I tried to design this as a self-contained example it might not work as expected on your system. In that case, please do not hesitate to get in touch directly.


[^howto_install]: How to install packages in R http://tinyurl.com/nh7whtp

[^fss-slov]: Statistics in Focus 87/2007: Farm Structure in Slovenia 2007 http://tinyurl.com/fss-slov

[^github-sources]: Source code used to create this document. If are not using git, you can also download sources as a regular zip archive. https://github.com/Tungurahua/R_examples
 

## Define the REST-Call and retrieve data
To programmatically access the Eurostat database we first need to assemble a so-called REST-id. This is a textual representation of the data we intend to download. Below is the specific REST-id for the data used to create the figures later in this document.

```{r idString,eval=FALSE}
idString = "ef_ov_lusum.A.TOTAL.D+E+F+G+H.HA.TOTAL.*"
```
While this is rather cryptic at first sight, you should note that the id starts out with the dataset code `ef_ov_lusum`. You can use this to interactively browse the dataset on the Eurostat homepage using the Eurostat-Data-Explorer. Figure \ref{fig:Data_browser} shows a session of this application. The highlighted tabs contain the information necessary to formulate the REST-id.

\begin{figure}
\label{fig:Data_browser}
\includegraphics{resources/Eurostat_REST.PNG}
\caption{The Eurostat Data Explorer is organized around the concepts of 'dataflow', 'Dimensions' and 'Codes'. Unfortunately it is not possible to extract the REST-id string from this application.}
\end{figure}


The translation of the information from the online Data-Explorer into the REST-id is possible if you know the generalized form of the REST-id. In our case this is:
```{r FullREST,message=TRUE, results='markup',tidy=FALSE,eval=FALSE }
idString = "[DataID].  # insert data-code here
            [FREQ].    # Frequency of data A -> Annual
            [TERRTYPO].# All agricultural holdings -> TOTAL
            [VARIABLE].# see discussion below
            [UNIT].    # Unit of data HA -> hectar
            [AGRAREA]. # All types of territory -> TOTAL
            [GEO]      # Countries *-> select all"
```
To create the specific ID it is necessary to replace the parts in square brackets with your selection where multiple selections are chained with \texttt{+} and a selecion of all available items is abbreviated as \texttt{*}. Manually building the REST call is not an easy task. While Eurostat provides a Rest-builder[^restbuild] tool on their website, it is implemented only for very few datasets. Fortunately the developer of `RSDMX` is currently working on a java tool[^javatool] which will provide a gui for the creation of REST-ids. Chances are good that this tool will be available once this document is finalized, so I will not bother to discuss alternative methods of assembling REST-ids here. However, if you are faced with the task of building a REST-id and the tool is not available yet, please get in touch with me so I can provide you with an alternative work-flow.

Using this REST-id we can issue the following commands to retrieve the data from Eurostat. The actual work is done by the \texttt{getSdmx()} function which will return an object of type \texttt{list}. For the subsequent steps we need to transform the list into a \texttt{dat.frame}.


```{r getData,cache=TRUE,tidy=FALSE}
# Define idString
idString = "ef_ov_lusum.A.TOTAL.D+E+F+G+H.HA.TOTAL.*"

# Retrieve data from Eurostat
listSdmx <- getSDMX(provider = "EUROSTAT",
                    id = idString,
                    start = "2007",
                    end="2007")

# Re-format into a dataframe
dfSdmx <- sdmxdf(listSdmx, meta = T)
```

On close inspection you will note that the 
[^fss-slov]
\begin{figure}
\centering
\includegraphics[width=8cm]{resources/Land_use_by_size_of_the_farms,_Slovenia,_2007.PNG}
\caption{Hierarchical structure of the Size-of-farms statistics at Eurostat. The structure of the dataset does not match the with the one shown in figure \ref{fig:25_eurostat}. }
\end{figure}


```{r getCodesVARIABLE,cache=TRUE}
VARIABLE_Codes <- getCodes(provider = "EUROSTAT",
           flow = "ef_ov_lusum",
           dimension = "VARIABLE")

VARIABLE_Codes <- data.frame(VARIABLE=names(VARIABLE_Codes),
                             labels=unlist(VARIABLE_Codes),
                             row.names=NULL)
```


<!-- References used in this section --> 
[^javatool]:  https://github.com/amattioc/SDMX/issues/41
[^restbuild]: Query Builder at Eurostat. Only available for limited numberof datasets. http://ec.europa.eu/eurostat/web/sdmx-web-services/query-builder
[^fss-slov]: Statistics in Focus 87/2007: Farm Structure in Slovenia 2007 http://tinyurl.com/fss-slov

# Re-organizing the dataset


```{r dplyr, warning=FALSE,message=FALSE,tidy=FALSE}
dfSdmx <- 
  dfSdmx %>%
  inner_join(VARIABLE_Codes)%>%
  select(GEO, VARIABLE,labels, OBS) %>%
#  arrange(GEO) %>%
  filter(!GEO %in% c("CH","FX")) %>%
  group_by(GEO) %>%
  mutate(PC=OBS/sum(OBS))

# Re-order GEO to display countries in alphabetical order
dfSdmx$GEO <-  factor(dfSdmx$GEO, levels = rev(levels(dfSdmx$GEO)))

# Re-name some VARIABLE levels for smaller legend
levels(dfSdmx$labels)[24] <- "Permanent grassland and meadows"
levels(dfSdmx$labels)[16] <- "Other"
```

# Create an initial plot

```{r firstplot,fig.cap="Hallo",fig.width=6,fig.height=6,warning=FALSE}
gg <- ggplot(data=dfSdmx, aes(x=GEO,y=PC,fill=labels,order=labels)  )
gg <- gg + geom_bar(stat="identity",width=0.5) 
gg <- gg + coord_flip() 
gg
```
\newpage

# Refine appearance

```{r windowdressing,fig.width=6,fig.height=6,message=FALSE,warning=FALSE,tidy=FALSE}
theme_qual <- function(base_size=11, base_family="") {
  require(grid)
  theme_bw(base_size=base_size, 
           base_family=base_family) %+replace%
    theme(axis.title=element_blank(),
      legend.position = "bottom",
      legend.title=element_blank())
}

gg <- gg +  theme_qual()
gg <- gg + scale_fill_brewer(type = "qual")
gg <- gg + scale_y_continuous(labels = percent)
gg <- gg + guides(fill = guide_legend(keywidth = 0.8, 
                                      keyheight = 0.8,
                                      nrow = 2,
                                      byrow = TRUE))  
gg
```
\newpage

# An alternative Plot

```{r betterplot,fig.width=6,fig.height=6,warning=FALSE,message=FALSE}
dfSdmx$GEO <-  factor(dfSdmx$GEO, levels = rev(levels(dfSdmx$GEO)))

gg <- gg %+% dfSdmx
gg <- gg + coord_cartesian()+facet_wrap(facets = "labels",nrow = 5)
gg <- gg + scale_fill_brewer(type = "qual",guide=FALSE)
gg
```













